{
  "Name": "debian-11-worker-test",
  "Vars": {
    "build_date": {
      "Value": "${DATE}",
      "Description": "Build datestamp used to version the image."
    },
    "project_id": {
      "Value": "debian-worker-ks",
      "Description": "Project of Debian 11 worker image"
    }
  },
  "Sources": {
      "debian_worker_test.sh": "./scripts/debian_worker_test.sh"
  },
  "Steps": {
    "create-worker-disk": {
      "CreateDisks": [
        {
          "Name": "disk-worker",
          "SourceImage": "projects/${project_id}/global/images/debian-11-worker-v${DATE}",
          "Type": "pd-ssd",
          "NoCleanup": true
        }
      ]
    },
    "create-worker-instance": {
      "CreateInstances": [
        {
          "Name": "inst-worker",
          "Disks": [{"Source": "disk-worker"}],
          "MachineType": "e2-standard-4",
          "StartupScript": "debian_worker_test.sh",
          "MetaData": {
            "block-project-ssh-keys": "TRUE"
          }
        }
      ]
    },
    "wait-for-stop": {
      "TimeOut": "30m",
      "WaitForInstancesSignal": [
        {
          "Name": "inst-worker",
          "SerialOutput": {
            "Port": 1,
            "FailureMatch": "BuildFailed:",
            "SuccessMatch": "BuildSuccess:",
            "StatusMatch": "BuildStatus:"
          }
        }
      ]
    },
    "remove-worker-instance": {
      "DeleteResources": {
        "Instances": ["inst-worker"]
      }
    },
    "cleanup-resources": {
      "DeleteResources": {
        "Disks": ["disk-worker"]
      }
    }
  },
  "Dependencies": {
    "create-worker-instance": ["create-worker-disk"],
    "wait-for-stop": ["create-worker-instance"],
    "remove-worker-instance": ["wait-for-stop"],
    "cleanup-resources": ["remove-worker-instance"]
  }
}